import React, { useState, useEffect, useMemo } from 'react';
import { CustomerIntelligenceService } from '../services/CustomerIntelligenceService.js';
import CustomerProfileModal from './CustomerProfileModal.jsx';
import ChurnRiskHeatmap from './ChurnRiskHeatmap.jsx';
import { display, value } from '../utils/fields.js';
import './CustomerIntelligenceTab.css';

export default function CustomerIntelligenceTab() {
  const [rawData, setRawData] = useState([]);
  const [analytics, setAnalytics] = useState(null);
  const [loading, setLoading] = useState(true);
  const [lastUpdated, setLastUpdated] = useState(new Date());
  const [sortField, setSortField] = useState('customerName');
  const [sortDirection, setSortDirection] = useState('asc');
  const [filters, setFilters] = useState({
    tier: 'All',
    churnRisk: 'All',
    renewal: 'All',
    search: ''
  });
  const [currentPage, setCurrentPage] = useState(1);
  const [pageSize, setPageSize] = useState(25);
  const [selectedDrillDown, setSelectedDrillDown] = useState(null);
  
  // Profile modal state
  const [selectedCustomer, setSelectedCustomer] = useState(null);
  const [isProfileModalOpen, setIsProfileModalOpen] = useState(false);
  
  // User context for internal functionality (hidden from UI)
  const [userContext] = useState({
    role: 'analyst',
    name: 'Emma Thompson',
    title: 'Senior Marketing Analyst',
    assigned_segments: ['Premium', 'VIP'],
    assigned_regions: ['North America', 'Europe'],
    permissions: {
      viewSensitiveData: true,
      editCustomers: false,
      createCampaigns: true,
      exportData: true
    }
  });

  const service = useMemo(() => new CustomerIntelligenceService(), []);

  // Inline styles for buttons to force colors (highest specificity)
  const profileButtonStyle = {
    background: '#2563eb',
    color: 'white',
    border: '1px solid #2563eb',
    padding: '8px 12px',
    borderRadius: '6px',
    fontSize: '12px',
    fontWeight: '600',
    cursor: 'pointer',
    transition: 'all 0.2s ease',
    textTransform: 'uppercase',
    letterSpacing: '0.5px',
    boxShadow: '0 2px 4px rgba(0, 0, 0, 0.1)',
    minWidth: '60px',
    textAlign: 'center'
  };

  const snapshotButtonStyle = {
    background: '#ea580c',
    color: 'white',
    border: '1px solid #ea580c',
    padding: '8px 12px',
    borderRadius: '6px',
    fontSize: '12px',
    fontWeight: '600',
    cursor: 'pointer',
    transition: 'all 0.2s ease',
    textTransform: 'uppercase',
    letterSpacing: '0.5px',
    boxShadow: '0 2px 4px rgba(0, 0, 0, 0.1)',
    minWidth: '60px',
    textAlign: 'center'
  };

  useEffect(() => {
    loadCustomerData();
    
    // Auto-refresh every 3 minutes for real-time data
    const interval = setInterval(loadCustomerData, 3 * 60 * 1000);
    return () => clearInterval(interval);
  }, [service]);

  const loadCustomerData = async () => {
    setLoading(true);
    try {
      console.log('Loading customer data from x_hete_clv_maximiz_policy_holders table...');
      const policyHoldersData = await service.getCSMConsumerData();
      const analyticsData = service.generateCustomerAnalytics(policyHoldersData);
      
      setRawData(policyHoldersData);
      setAnalytics(analyticsData);
      setLastUpdated(new Date());
      console.log('Customer Intelligence data loaded successfully from policy holders table');
      
      // Log high risk customer information for transparency
      if (analyticsData.highRiskCustomers) {
        console.log(`üö® High Risk Customers loaded: ${analyticsData.highRiskCustomers.length} customers`);
      }
    } catch (error) {
      console.error('Error loading customer intelligence data:', error);
    } finally {
      setLoading(false);
    }
  };

  // Filter and search customers with drill-down support
  const filteredCustomers = useMemo(() => {
    if (!analytics) return [];
    
    let filtered = analytics.customers;

    // Apply tier filter with drill-down support
    if (filters.tier !== 'All') {
      filtered = filtered.filter(customer => customer.tier === filters.tier);
    }

    // Apply churn risk filter with drill-down support - KEY FOR HIGH RISK FILTERING
    if (filters.churnRisk !== 'All') {
      filtered = filtered.filter(customer => customer.churnRisk === filters.churnRisk);
      console.log(`üéØ Filtered to ${filters.churnRisk} risk customers: ${filtered.length} found`);
    }

    // Apply renewal filter with drill-down support
    if (filters.renewal !== 'All') {
      filtered = filtered.filter(customer => customer.renewal === filters.renewal);
    }

    // Apply search filter across multiple fields
    if (filters.search) {
      const term = filters.search.toLowerCase();
      filtered = filtered.filter(customer => 
        customer.customerName.toLowerCase().includes(term) ||
        customer.email.toLowerCase().includes(term) ||
        customer.company.toLowerCase().includes(term) ||
        customer.location.toLowerCase().includes(term)
      );
    }

    return filtered;
  }, [analytics, filters]);

  // Sort customers with comprehensive sorting options
  const sortedCustomers = useMemo(() => {
    const sorted = [...filteredCustomers].sort((a, b) => {
      let aVal, bVal;

      switch (sortField) {
        case 'customerName':
          aVal = a.customerName.toLowerCase();
          bVal = b.customerName.toLowerCase();
          break;
        case 'tier':
          aVal = service.getTierPriority(a.tier);
          bVal = service.getTierPriority(b.tier);
          break;
        case 'clv':
          aVal = a.clv;
          bVal = b.clv;
          break;
        case 'renewalDate':
          aVal = new Date(a.renewalDate);
          bVal = new Date(b.renewalDate);
          break;
        case 'churnRisk':
          aVal = service.getChurnPriority(a.churnRisk);
          bVal = service.getChurnPriority(b.churnRisk);
          break;
        case 'engagementScore':
          aVal = a.engagementScore;
          bVal = b.engagementScore;
          break;
        case 'tenure':
          aVal = a.tenure;
          bVal = b.tenure;
          break;
        default:
          return 0;
      }

      if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
      if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
      return 0;
    });

    return sorted;
  }, [filteredCustomers, sortField, sortDirection, service]);

  // Paginate customers with "X of Y customers" display
  const paginatedCustomers = useMemo(() => {
    const startIndex = (currentPage - 1) * pageSize;
    return sortedCustomers.slice(startIndex, startIndex + pageSize);
  }, [sortedCustomers, currentPage, pageSize]);

  const totalPages = Math.ceil(sortedCustomers.length / pageSize);

  // Handle sorting with visual indicators
  const handleSort = (field) => {
    if (sortField === field) {
      setSortDirection(prev => prev === 'asc' ? 'desc' : 'asc');
    } else {
      setSortField(field);
      setSortDirection('asc');
    }
    setCurrentPage(1);
  };

  // Handle filter changes with drill-down support
  const handleFilterChange = (filterName, value) => {
    setFilters(prev => ({
      ...prev,
      [filterName]: value
    }));
    setCurrentPage(1);
  };

  // Handle drill-down clicks from summary cards and charts
  const handleDrillDown = (type, value) => {
    let drillDownFilters = { ...filters };
    
    switch (type) {
      case 'total':
        // Reset all filters to show all customers
        drillDownFilters = { tier: 'All', churnRisk: 'All', renewal: 'All', search: '' };
        console.log('üîç Showing all customers from policy holders table');
        break;
      case 'highRisk':
        // Filter to show only high risk customers - KEY FUNCTIONALITY
        drillDownFilters.churnRisk = 'High';
        console.log('üö® Filtering to HIGH RISK customers from policy holders table');
        break;
      case 'platinum':
        drillDownFilters.tier = 'Platinum';
        console.log('üèÜ Filtering to Platinum tier customers');
        break;
      case 'churnRisk':
        drillDownFilters.churnRisk = value;
        console.log(`‚ö†Ô∏è Filtering to ${value} risk customers`);
        break;
      case 'renewalUrgent':
        // Filter for customers with renewals in next 30 days
        setSelectedDrillDown({ type: 'renewalUrgent', customers: analytics.customers.filter(c => service.getDaysUntilRenewal(c.renewalDate) <= 30) });
        console.log('üìÖ Filtering to urgent renewal customers');
        return;
    }
    
    setFilters(drillDownFilters);
    setCurrentPage(1);
  };

  // Handle customer profile modal
  const handleViewProfile = (customer) => {
    setSelectedCustomer(customer);
    setIsProfileModalOpen(true);
  };

  const handleCloseProfile = () => {
    setIsProfileModalOpen(false);
    setSelectedCustomer(null);
  };

  // Handle quick customer snapshot - Enhanced for high risk customers
  const handleViewSnapshot = (customer) => {
    const churnInfo = customer.churnRiskPercent ? ` (${customer.churnRiskPercent}% risk)` : '';
    alert(`Quick Snapshot - ${customer.customerName}:\n\n` +
          `${customer.tier} Customer | CLV: ${service.formatCurrency(customer.clv)}\n` +
          `Churn Risk: ${customer.churnRisk}${churnInfo} | Engagement: ${customer.engagementScore}/100\n` +
          `Renewal: ${service.formatDate(customer.renewalDate)} (${service.getDaysUntilRenewal(customer.renewalDate)} days)\n` +
          `Top Opportunity: ${customer.opportunities[0] || 'None identified'}\n` +
          `Risk Factors: ${customer.riskFactors.join(', ')}\n` +
          `Data Source: x_hete_clv_maximiz_policy_holders table`);
  };

  // Button hover handlers for inline styles
  const handleProfileHover = (e, isHovering) => {
    if (isHovering) {
      e.target.style.background = '#1d4ed8';
      e.target.style.borderColor = '#1d4ed8';
      e.target.style.transform = 'translateY(-2px)';
      e.target.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.4)';
    } else {
      e.target.style.background = '#2563eb';
      e.target.style.borderColor = '#2563eb';
      e.target.style.transform = 'translateY(0)';
      e.target.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';
    }
  };

  const handleSnapshotHover = (e, isHovering) => {
    if (isHovering) {
      e.target.style.background = '#dc2626';
      e.target.style.borderColor = '#dc2626';
      e.target.style.transform = 'translateY(-2px)';
      e.target.style.boxShadow = '0 4px 12px rgba(234, 88, 12, 0.4)';
    } else {
      e.target.style.background = '#ea580c';
      e.target.style.borderColor = '#ea580c';
      e.target.style.transform = 'translateY(0)';
      e.target.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';
    }
  };

  // Utility functions
  const getSortIndicator = (field) => {
    if (sortField !== field) return '‚ÜïÔ∏è';
    return sortDirection === 'asc' ? '‚ÜóÔ∏è' : '‚ÜòÔ∏è';
  };

  if (loading) {
    return (
      <div className="intelligence-loading">
        <div className="loading-spinner"></div>
        <p>Loading Customer Intelligence Hub...</p>
        <small>Fetching data from x_hete_clv_maximiz_policy_holders table...</small>
      </div>
    );
  }

  if (!analytics) {
    return (
      <div className="intelligence-error">
        <p>Error loading customer intelligence data. Please try again.</p>
        <button onClick={loadCustomerData}>Retry</button>
      </div>
    );
  }

  return (
    <div className="customer-intelligence-hub">
      {/* Section 1: Clean Header Panel */}
      <header className="intelligence-header">
        <div className="header-content">
          <h1>Customer Intelligence Hub</h1>
          <p className="header-subtitle">Advanced analytics and insights for customer lifetime value optimization</p>
        </div>
      </header>

      {/* Section 2: Summary Metrics Panel */}
      <section className="summary-metrics-panel">
        <div className="metric-card" onClick={() => handleDrillDown('total', 'all')} title="Click to view all customers from policy holders table">
          <div className="metric-icon">üë•</div>
          <div className="metric-content">
            <div className="metric-value">{analytics.summaryMetrics.totalCustomers.toLocaleString()}</div>
            <div className="metric-label">Total Customers</div>
          </div>
          <div className="metric-trend positive">‚Üó +5.2%</div>
        </div>

        <div className="metric-card" onClick={() => handleDrillDown('highRisk', 'high')} title="Click to view high risk customers (churn risk ‚â• 70%) from policy holders table">
          <div className="metric-icon">‚ö†Ô∏è</div>
          <div className="metric-content">
            <div className="metric-value">{analytics.summaryMetrics.highRiskCount.toLocaleString()}</div>
            <div className="metric-label">High Risk Customers</div>
          </div>
          <div className="metric-trend negative">‚Üò -2.1%</div>
        </div>

        <div className="metric-card" title="Average customer lifetime value from policy holders">
          <div className="metric-icon">üí∞</div>
          <div className="metric-content">
            <div className="metric-value">{service.formatCurrency(analytics.summaryMetrics.averageCLV)}</div>
            <div className="metric-label">Average CLV</div>
          </div>
          <div className="metric-trend positive">‚Üó +8.3%</div>
        </div>

        <div className="metric-card" onClick={() => handleDrillDown('platinum', 'platinum')} title="Click to view Platinum tier customers from policy holders table">
          <div className="metric-icon">üèÜ</div>
          <div className="metric-content">
            <div className="metric-value">{analytics.summaryMetrics.platinumCount.toLocaleString()}</div>
            <div className="metric-label">Platinum Tier Count</div>
          </div>
          <div className="metric-trend positive">‚Üó +3.7%</div>
        </div>
      </section>

      <div className="analytics-grid">
        <div className="analytics-main">
          {/* Section 3: Enhanced Churn Risk Heatmap */}
          <ChurnRiskHeatmap 
            analytics={analytics}
            onDrillDown={handleDrillDown}
          />

          {/* Section 4: Renewal Timeline Heatmap */}
          <section className="renewal-timeline-heatmap">
            <h2>Renewal Timeline Heatmap</h2>
            <div className="timeline-bars">
              <div className="timeline-segment urgent" onClick={() => handleDrillDown('renewalUrgent')} title="Click to view urgent renewals">
                <div className="segment-header">
                  <span className="segment-label">Next 30 Days</span>
                  <span className="urgent-badge">URGENT</span>
                </div>
                <div className="segment-count">{analytics.renewalTimeline.next30.count} customers</div>
                <div className="segment-bar">
                  <div 
                    className="segment-fill" 
                    style={{ 
                      width: `${Math.max(20, (analytics.renewalTimeline.next30.count / Math.max(analytics.summaryMetrics.totalCustomers, 1)) * 100 * 3)}%`,
                      backgroundColor: analytics.renewalTimeline.next30.color 
                    }}
                  ></div>
                </div>
              </div>

              <div className="timeline-segment" title="Renewals in 31-60 days">
                <div className="segment-header">
                  <span className="segment-label">31‚Äì60 Days</span>
                </div>
                <div className="segment-count">{analytics.renewalTimeline.days31to60.count} customers</div>
                <div className="segment-bar">
                  <div 
                    className="segment-fill" 
                    style={{ 
                      width: `${Math.max(15, (analytics.renewalTimeline.days31to60.count / Math.max(analytics.summaryMetrics.totalCustomers, 1)) * 100 * 3)}%`,
                      backgroundColor: analytics.renewalTimeline.days31to60.color 
                    }}
                  ></div>
                </div>
              </div>

              <div className="timeline-segment" title="Renewals in 61-90 days">
                <div className="segment-header">
                  <span className="segment-label">61‚Äì90 Days</span>
                </div>
                <div className="segment-count">{analytics.renewalTimeline.days61to90.count} customers</div>
                <div className="segment-bar">
                  <div 
                    className="segment-fill" 
                    style={{ 
                      width: `${Math.max(10, (analytics.renewalTimeline.days61to90.count / Math.max(analytics.summaryMetrics.totalCustomers, 1)) * 100 * 3)}%`,
                      backgroundColor: analytics.renewalTimeline.days61to90.color 
                    }}
                  ></div>
                </div>
              </div>
            </div>
          </section>
        </div>
      </div>

      {/* Section 5: Customer Profile List */}
      <section className="customer-profile-list">
        <div className="list-header">
          <h2>Customer Profile List</h2>
          <div className="list-controls">
            <input
              type="text"
              placeholder="Search customers..."
              value={filters.search}
              onChange={(e) => handleFilterChange('search', e.target.value)}
              className="search-input"
              aria-label="Search customers by name, email, company, or location"
            />
            
            <select
              value={filters.tier}
              onChange={(e) => handleFilterChange('tier', e.target.value)}
              className="filter-select"
              aria-label="Filter by CLV tier"
            >
              <option value="All">All Tiers</option>
              <option value="Platinum">Platinum</option>
              <option value="Gold">Gold</option>
              <option value="Silver">Silver</option>
              <option value="Bronze">Bronze</option>
            </select>

            <select
              value={filters.churnRisk}
              onChange={(e) => handleFilterChange('churnRisk', e.target.value)}
              className="filter-select"
              aria-label="Filter by churn risk level"
            >
              <option value="All">All Risk Levels</option>
              <option value="High">High Risk (‚â•70%)</option>
              <option value="Medium">Medium Risk (40-69%)</option>
              <option value="Low">Low Risk (<40%)</option>
            </select>

            <select
              value={filters.renewal}
              onChange={(e) => handleFilterChange('renewal', e.target.value)}
              className="filter-select"
              aria-label="Filter by renewal status"
            >
              <option value="All">All Renewals</option>
              <option value="Yes">Has Renewal</option>
              <option value="No">No Renewal</option>
            </select>
          </div>
        </div>

        <div className="results-summary">
          <span>Showing {paginatedCustomers.length} of {sortedCustomers.length} customers</span>
          {filters.churnRisk === 'High' && (
            <span className="filter-indicator high-risk">üö® HIGH RISK CUSTOMERS ONLY</span>
          )}
          {(filters.search || filters.tier !== 'All' || filters.churnRisk !== 'All' || filters.renewal !== 'All') && (
            <span className="filter-indicator">Filtered results</span>
          )}
        </div>

        <div className="table-container">
          <table className="customer-table" role="table">
            <thead>
              <tr>
                <th onClick={() => handleSort('customerName')} className="sortable" title="Click to sort by name">
                  Name {getSortIndicator('customerName')}
                </th>
                <th onClick={() => handleSort('tier')} className="sortable" title="Click to sort by CLV tier">
                  CLV Tier {getSortIndicator('tier')}
                </th>
                <th onClick={() => handleSort('clv')} className="sortable" title="Click to sort by CLV amount">
                  CLV (12M) {getSortIndicator('clv')}
                </th>
                <th onClick={() => handleSort('renewal')} className="sortable" title="Click to sort by renewal status">
                  Renewal {getSortIndicator('renewal')}
                </th>
                <th onClick={() => handleSort('churnRisk')} className="sortable" title="Click to sort by churn risk">
                  Churn Risk {getSortIndicator('churnRisk')}
                </th>
                <th onClick={() => handleSort('engagementScore')} className="sortable" title="Click to sort by engagement score">
                  Engagement Score {getSortIndicator('engagementScore')}
                </th>
                <th onClick={() => handleSort('tenure')} className="sortable" title="Click to sort by tenure">
                  Tenure {getSortIndicator('tenure')}
                </th>
                <th>Location</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {paginatedCustomers.map((customer) => (
                <tr key={customer.id} className={`customer-row ${customer.churnRisk === 'High' ? 'high-risk-row' : ''}`}>
                  <td className="customer-name-cell">
                    <div className="name-info">
                      <div className="name-row">
                        <button 
                          className="profile-icon-btn"
                          onClick={() => handleViewProfile(customer)}
                          title="View detailed customer profile"
                          aria-label={`View profile for ${customer.customerName}`}
                        >
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                          </svg>
                        </button>
                        <strong>{customer.customerName}</strong>
                        {customer.churnRisk === 'High' && <span className="high-risk-indicator">üö®</span>}
                      </div>
                      <small>{customer.email}</small>
                    </div>
                  </td>
                  <td>
                    <span className={`tier-badge tier-${customer.tier.toLowerCase()}`}>
                      {customer.tier}
                    </span>
                  </td>
                  <td className="clv-cell">
                    <strong>{service.formatCurrency(customer.clv)}</strong>
                  </td>
                  <td className="renewal-cell">
                    <span className={`renewal-status ${customer.renewal.toLowerCase()}`}>
                      {customer.renewal}
                    </span>
                  </td>
                  <td>
                    <span 
                      className={`churn-badge churn-${customer.churnRisk.toLowerCase()}`}
                      title={`Risk factors: ${customer.riskFactors.join(', ')}${customer.churnRiskPercent ? ` (${customer.churnRiskPercent}% probability)` : ''}`}
                    >
                      {customer.churnRisk}
                      {customer.churnRiskPercent && <small> ({customer.churnRiskPercent}%)</small>}
                    </span>
                  </td>
                  <td className="engagement-cell">
                    <span className="engagement-score">{customer.engagementScore}</span>
                  </td>
                  <td className="tenure-cell">
                    {customer.tenure} months
                  </td>
                  <td className="location-cell">
                    {customer.location}
                  </td>
                  <td className="actions-cell">
                    <button 
                      style={profileButtonStyle}
                      onClick={() => handleViewProfile(customer)}
                      onMouseEnter={(e) => handleProfileHover(e, true)}
                      onMouseLeave={(e) => handleProfileHover(e, false)}
                      title="View detailed customer profile"
                    >
                      Profile
                    </button>
                    <button 
                      style={snapshotButtonStyle}
                      onClick={() => handleViewSnapshot(customer)}
                      onMouseEnter={(e) => handleSnapshotHover(e, true)}
                      onMouseLeave={(e) => handleSnapshotHover(e, false)}
                      title="Quick customer snapshot"
                    >
                      Snapshot
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        {/* Pagination with "X of Y customers" display */}
        {totalPages > 1 && (
          <div className="pagination">
            <button 
              className="page-btn"
              onClick={() => setCurrentPage(prev => Math.max(prev - 1, 1))}
              disabled={currentPage === 1}
              aria-label="Previous page"
            >
              ‚Üê Previous
            </button>
            
            <div className="page-numbers">
              {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
                let pageNum;
                if (totalPages <= 5) {
                  pageNum = i + 1;
                } else if (currentPage <= 3) {
                  pageNum = i + 1;
                } else if (currentPage >= totalPages - 2) {
                  pageNum = totalPages - 4 + i;
                } else {
                  pageNum = currentPage - 2 + i;
                }
                
                return (
                  <button
                    key={pageNum}
                    className={`page-btn ${currentPage === pageNum ? 'active' : ''}`}
                    onClick={() => setCurrentPage(pageNum)}
                    aria-label={`Page ${pageNum}`}
                  >
                    {pageNum}
                  </button>
                );
              })}
            </div>
            
            <button 
              className="page-btn"
              onClick={() => setCurrentPage(prev => Math.min(prev + 1, totalPages))}
              disabled={currentPage === totalPages}
              aria-label="Next page"
            >
              Next ‚Üí
            </button>
            
            <span className="page-info">
              {pageSize} of {sortedCustomers.length} customers
            </span>
          </div>
        )}
      </section>

      {/* Customer Profile Modal */}
      <CustomerProfileModal
        customer={selectedCustomer}
        isOpen={isProfileModalOpen}
        onClose={handleCloseProfile}
        userContext={userContext}
      />
    </div>
  );
}